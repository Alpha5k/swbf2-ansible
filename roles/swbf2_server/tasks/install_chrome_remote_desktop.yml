---
# tasks file for installing and configuring Chrome Remote Desktop
- name: Check if Chrome Remote Desktop Host is installed
  ansible.windows.win_stat:
    path: "C:\\Program Files\\Google\\Chrome Remote Desktop\\{{ item }}.exe"
  loop:
    - "remoting_desktop_host"
    - "remoting_host"
  register: crd_check
  failed_when: false

- name: Set Chrome Remote Desktop installation status
  ansible.builtin.set_fact:
    crd_installed: "{{ crd_check.results | selectattr('stat.exists', 'equalto', true) | list | length > 0 }}"

- name: Create temp directory for Chrome Remote Desktop installer
  ansible.windows.win_tempfile:
    state: directory
    suffix: crd_installer
  register: crd_temp_dir
  when: not crd_installed

- name: Download Chrome Remote Desktop Host MSI installer
  ansible.windows.win_get_url:
    url: "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
    dest: "{{ crd_temp_dir.path }}\\chromeremotedesktophost.msi"
  when: not crd_installed

- name: Install Chrome Remote Desktop Host silently
  ansible.windows.win_package:
    path: "{{ crd_temp_dir.path }}\\chromeremotedesktophost.msi"
    state: present
    arguments: "/qn /norestart"
  when: not crd_installed
  register: crd_install_result

- name: Clean up Chrome Remote Desktop installer
  ansible.windows.win_file:
    path: "{{ crd_temp_dir.path }}"
    state: absent
  when: not crd_installed

- name: Wait for Chrome Remote Desktop installation to complete
  ansible.builtin.pause:
    seconds: 10
  when: not crd_installed or crd_install_result.changed

- name: Check if Chrome Remote Desktop service exists
  ansible.windows.win_service:
    name: chromoting
  register: crd_service
  failed_when: false
  changed_when: false

- name: Ensure Chrome Remote Desktop service is running
  ansible.windows.win_service:
    name: chromoting
    state: started
    start_mode: auto
  when: crd_service.exists
  register: crd_service_start

- name: Get current user information for Chrome Remote Desktop configuration
  ansible.windows.win_shell: |
    $currentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    @{
      Username = $currentUser.Name
      SID = $currentUser.User.Value
      Account = $currentUser.Name.Split('\')[-1]
    } | ConvertTo-Json
  register: current_user_info
  changed_when: false

- name: Ensure Chrome Remote Desktop registry path exists
  ansible.windows.win_registry:
    path: HKLM:\SOFTWARE\Google\Chrome Remote Desktop
    state: present
  register: crd_registry_setup

- name: Store Chrome Remote Desktop PIN reference in registry
  ansible.windows.win_registry:
    path: HKLM:\SOFTWARE\Google\Chrome Remote Desktop
    name: PinReference
    data: "{{ chrome_remote_desktop_pin | default('') }}"
    type: string
  when: chrome_remote_desktop_pin is defined
  no_log: true

- name: Configure Chrome Remote Desktop for headless access
  ansible.windows.win_shell: |
    $crdPath = "${env:ProgramFiles}\Google\Chrome Remote Desktop"
    $hostExe = Join-Path $crdPath "remoting_host.exe"
    
    if (Test-Path $hostExe) {
      # Check if Chrome Remote Desktop is already authorized
      $regPath = "HKLM:\SOFTWARE\Google\Chrome Remote Desktop"
      $authKey = Get-ItemProperty -Path $regPath -Name "AuthKey" -ErrorAction SilentlyContinue
      
      if (-not $authKey) {
        Write-Output "Chrome Remote Desktop installed. Authorization required through Chrome browser."
      } else {
        Write-Output "Chrome Remote Desktop is configured"
      }
    }
  register: crd_config_check
  changed_when: false

- name: Display Chrome Remote Desktop setup information
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════════"
      - "Chrome Remote Desktop Host Installation Complete"
      - "═══════════════════════════════════════════════════════════════"
      - "Next Steps (REQUIRED for full functionality):"
      - "1. Log in to the server interactively (RDP or console)"
      - "2. Open Google Chrome (installed in previous step)"
      - "3. Install Chrome Remote Desktop extension:"
      - "   https://chrome.google.com/webstore/detail/chrome-remote-desktop/inomeogfingihgjfjlpeplalcfajhgai"
      - "4. Open the extension and click 'Get Started' under 'Remote Access'"
      - "5. Click 'Enable Remote Connections'"
      - "6. When prompted, set your PIN: {{ chrome_remote_desktop_pin | default('(use your preferred PIN)') }}"
      - "7. The PIN has been stored for reference: {{ chrome_remote_desktop_pin | default('Not set') }}"
      - ""
      - "Note: The 'chromoting' service is configured to start automatically"
      - "═══════════════════════════════════════════════════════════════"
  when: crd_installed or crd_install_result.changed

