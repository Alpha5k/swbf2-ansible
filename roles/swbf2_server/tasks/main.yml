---
# tasks file for swbf2_server
# This file contains the main tasks for deploying Star Wars Battlefront 2 game server

- name: Change ansible user password
  ansible.windows.win_user:
    name: "{{ ansible_user | default(ansible_user_name) }}"
    password: "{{ ansible_user_new_password }}"
    password_never_expires: no
    state: present
  no_log: true  # Prevent password from appearing in logs
  register: res

- name: Update connection password variables for subsequent tasks
  ansible.builtin.set_fact:
    ansible_password: "{{ ansible_user_new_password }}"
    ansible_winrm_pass: "{{ ansible_user_new_password }}"
  when: res.changed
  no_log: true

- name: Reset connection to use new password
  ansible.builtin.meta: reset_connection

- name: Change computer name to match inventory hostname
  ansible.windows.win_hostname:
    name: "{{ inventory_hostname }}"
  register: res

- name: Reboot if hostname changed
  ansible.windows.win_reboot:
  when: res.reboot_required

- name: Install all updates and reboot as many times as needed
  ansible.windows.win_updates:
    category_names: '*'
    reboot: true

- name: Configure system settings (RDP, Performance, DEP)
  ansible.builtin.import_tasks: configure_system_settings.yml

- name: Configure AutoLogon for ansible user
  ansible.builtin.import_tasks: configure_autologon.yml

- name: Install VirtIO drivers
  ansible.builtin.import_tasks: install_virtio.yml

- name: Install Visual C++ Redistributables
  ansible.builtin.import_tasks: install_vcredist.yml

- name: Install Dependencies
  ansible.builtin.import_tasks: install_dependencies.yml

- name: Download and extract SWBF2 server
  ansible.builtin.import_tasks: download_swbf2_server.yml

- name: Configure SWBF2 server
  ansible.builtin.import_tasks: configure_swbf2_server.yml

- name: Configure Firewall rules
  ansible.builtin.import_tasks: configure_firewall.yml

- name: Display manual tasks reminder
  ansible.builtin.import_tasks: manual_tasks_reminder.yml

