---
# tasks file for installing VirtIO drivers
- name: Windows | Download Virtio ISO
  ansible.windows.win_get_url:
    url: '{{ virtio_iso_url }}'
    dest: "{{ virtio_iso_dest }}"
    force: "{{ virtio_update }}"
    follow_redirects: all

- name: Windows | Mount Virtio ISO
  community.windows.win_disk_image:
    image_path: "{{ virtio_iso_dest }}"
    state: present
  register: disk_image_out
  changed_when: false

- name: Windows | Install Virtio
  ansible.windows.win_package:
    path: '{{ disk_image_out.mount_paths[0] }}virtio-win-gt-x64.msi'
    state: present

- name: Windows | Install Qemu Guest Agent and Spice agent
  ansible.windows.win_package:
    path: '{{ disk_image_out.mount_paths[0] }}virtio-win-guest-tools.exe'
    arguments: /install /passive /norestart
    creates_path: "{{ ansible_env['ProgramFiles'] }}\\qemu-ga"
    state: present

- name: Windows | Unmount virtio-win.iso
  community.windows.win_disk_image:
    image_path: "{{ virtio_iso_dest }}"
    state: absent
  changed_when: false